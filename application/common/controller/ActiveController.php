<?php
namespace app\common\controller;


class ActiveController extends ApiBaseController
{

    protected $modelClass;
    protected $condition;

    /**
     * 初始方法
     */
    public function _initialize(){
        //api跨域
        header("Access-Control-Allow-Origin:*");
        header("Access-Control-Allow-Headers:Origin,X-Requested-With,Content-Type,Accept");
        header("Access-Control-Allow-Methods:DELETE,PUT");

        if(!$this->modelClass){
            error('控制器的modelClass未定义！');
        }
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    /**
     * find model
     * @param $id
     * @return mixed
     */
    protected  function findModel($id){

        $modelClass = $this->modelClass;
        $this->condition['id']=$id;
        $model = $modelClass::get($this->condition);

        if(!$model){
            apiError("你没权限操作或该记录已经被删除！");
        }
        return $model;
    }

    /**
     * find list
     * @return mixed
     */
    protected function prepareDataProvider(){
        $modelClass = $this->modelClass;
        if($this->condition){
            $list = $modelClass::where($this->condition)->paginate(20);
        }else{
            $list = $modelClass::paginate(20);
        }
        return $list;
    }


    /**
     * 列表（分页）
     */
    public function index(){
        $list = $this->prepareDataProvider();
        success($list);
    }

    /**
     * 详情
     */
    public function read($id){
        $model = $this->findModel($id);
        if($model){
            success($model);
        }else{
            error("没有改ID的结果记录哦！");
        }

    }

    /**
     * 保存（新增）
     */
    public function save(){

        $param = $_POST;
        if($param == null)$param = json_decode(file_get_contents("php://input"),true);
        if($param == null)error("你没有提交参数哦！");

        $modelClass = $this->modelClass;
        $m = $modelClass::create($param);
        if($m){
            success($m);
        }else{
            error($modelClass->getError);
        }
    }

    /**
     * 修改
     */
    public function update($id){

        $param = $_POST;
        if($param == null)$param = json_decode(file_get_contents("php://input"),true);
        if($param == null)error("你没有提交参数哦！");

        $modelClass = $this->modelClass;
        $this->condition['id']=$id;
        $rt=$modelClass::where($this->condition)->allowField(true)->update($param);
        if($rt){
            success();
        }else{
            error($modelClass->getError);
        }
    }

    /**
     * 删除
     */
    public function delete($id){

        $modelClass = $this->modelClass;
        $this->condition['id']=$id;
        $rt = $modelClass::destroy($this->condition);
        if($rt){
            success();
        }else{
            error($modelClass->getError);
        }
    }


}
