<!-- 边栏 -->
{include file="apidoc/left_menu" /}

<!-- 内容区 -->
<div id="main-content">
    <div id="top-alert" class="fixed alert alert-error" style="display: none;">
        <button class="close fixed" style="margin-top: 4px;">&times;</button>
        <div class="alert-content">这是内容</div>
    </div>
    <div id="main" class="main">

        <div class="main-title">
            <h2>用户系统接口</h2>
        </div>
        <div class="tab-wrap">
            <div>参照如下代码接入：TinkPHP 5.0.9，其他控制器继承该控制器！</div>
            <pre style="font-family: 宋体; font-size: 12pt; background-color: rgb(255, 255, 255);"><span style="color:#000080;background-color:#f7faff;"><strong>&lt;?php
</strong></span><span style="color:#000080;background-color:#f7faff;"><strong>namespace </strong></span><span style="background-color:#f7faff;">common\controller;
</span><span style="background-color:#f7faff;">
</span><span style="color:#000080;background-color:#f7faff;"><strong>use </strong></span><span style="background-color:#f7faff;">think\Cache;
</span><span style="color:#000080;background-color:#f7faff;"><strong>use </strong></span><span style="background-color:#f7faff;">think\Controller;
</span><span style="color:#000080;background-color:#f7faff;"><strong>use </strong></span><span style="background-color:#f7faff;">think\Request;
</span><span style="color:#000080;background-color:#f7faff;"><strong>use </strong></span><span style="background-color:#f7faff;">think\Validate;
</span><span style="color:#000080;background-color:#f7faff;"><strong>use </strong></span><span style="background-color:#f7faff;">tools\HttpClient;
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">
</span><span style="color:#000080;background-color:#f7faff;"><strong>class </strong></span><span style="background-color:#f7faff;">ApiBaseController </span><span style="color:#000080;background-color:#f7faff;"><strong>extends </strong></span><span style="background-color:#f7faff;">Controller
</span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">    </span><span style="color:#000080;background-color:#f7faff;"><strong>protected </strong></span><span style="color:#660e7a;background-color:#f7faff;"><strong>$accessToken</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">    </span><span style="color:#000080;background-color:#f7faff;"><strong>protected </strong></span><span style="color:#660e7a;background-color:#f7faff;"><strong>$user</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">    </span><span style="color:#000080;background-color:#f7faff;"><strong>protected </strong></span><span style="color:#660e7a;background-color:#f7faff;"><strong>$userId</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">    </span><span style="color:#000080;background-color:#f7faff;"><strong>protected </strong></span><span style="color:#660e7a;background-color:#f7faff;"><strong>$loginAuth</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">_initialize()
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken </strong></span><span style="background-color:#f7faff;">= Request::</span><span style="background-color:#f7faff;"><em>instance</em></span><span style="background-color:#f7faff;">()-&gt;header(</span><span style="color:#008000;background-color:#f7faff;"><strong>'access-token'</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(strlen(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">) &lt; </span><span style="color:#0000ff;background-color:#f7faff;">24</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">                api(</span><span style="color:#0000ff;background-color:#f7faff;">102</span><span style="background-color:#f7faff;">, </span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;access-token无效！&quot;</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">            }
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;authenticate(); </span><span style="color:#808080;background-color:#f7faff;"><em>//只要接口带了token就去验证身份，此时$loginAuth就失效了
</em></span><span style="color:#808080;background-color:#f7faff;"><em>
</em></span><span style="color:#808080;background-color:#f7faff;"><em>        </em></span><span style="background-color:#f7faff;">} </span><span style="color:#000080;background-color:#f7faff;"><strong>else </strong></span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">            </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>loginAuth</strong></span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">                </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>beforeActionList</strong></span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'loginAuth'</strong></span><span style="background-color:#f7faff;">] = </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>loginAuth</strong></span><span style="background-color:#f7faff;">; </span><span style="color:#808080;background-color:#f7faff;"><em>//无token时，（自定义）验证登录\无需验证登录
</em></span><span style="color:#808080;background-color:#f7faff;"><em>            </em></span><span style="background-color:#f7faff;">} </span><span style="color:#000080;background-color:#f7faff;"><strong>else </strong></span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">                </span><span style="color:#000080;background-color:#f7faff;"><strong>if</strong></span><span style="background-color:#f7faff;">(!</span><span style="color:#000080;background-color:#f7faff;"><strong>isset</strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>beforeActionList</strong></span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'loginAuth'</strong></span><span style="background-color:#f7faff;">])){
</span><span style="background-color:#f7faff;">                    </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>beforeActionList</strong></span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'loginAuth'</strong></span><span style="background-color:#f7faff;">] = </span><span style="color:#000080;background-color:#f7faff;"><strong>null</strong></span><span style="background-color:#f7faff;">;</span><span style="color:#808080;background-color:#f7faff;"><em>//无token时，（默认）验证登录
</em></span><span style="color:#808080;background-color:#f7faff;"><em>                </em></span><span style="background-color:#f7faff;">}
</span><span style="background-color:#f7faff;">            }
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * 登录
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>$user
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@return </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>bool
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">doLogin(</span><span style="color:#660000;background-color:#f7faff;">$user</span><span style="background-color:#f7faff;">)
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken </strong></span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$user</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'access_token'</strong></span><span style="background-color:#f7faff;">];
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>user </strong></span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$user</span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>userId </strong></span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$user</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'yunsu_id'</strong></span><span style="background-color:#f7faff;">];
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$rt </span><span style="background-color:#f7faff;">= Cache::</span><span style="background-color:#f7faff;"><em>set</em></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$user</span><span style="background-color:#f7faff;">, </span><span style="color:#0000ff;background-color:#f7faff;">10 </span><span style="background-color:#f7faff;">* </span><span style="color:#0000ff;background-color:#f7faff;">24 </span><span style="background-color:#f7faff;">* </span><span style="color:#0000ff;background-color:#f7faff;">60 </span><span style="background-color:#f7faff;">* </span><span style="color:#0000ff;background-color:#f7faff;">60</span><span style="background-color:#f7faff;">);</span><span style="color:#808080;background-color:#f7faff;"><em>//token有效期两个小时 调试时间为10天有效
</em></span><span style="color:#808080;background-color:#f7faff;"><em>        </em></span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(!</span><span style="color:#660000;background-color:#f7faff;">$rt</span><span style="background-color:#f7faff;">) </span><span style="color:#000080;background-color:#f7faff;"><strong>die</strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$rt</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>return true</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * 登录权限
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">loginAuth()
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken </strong></span><span style="background-color:#f7faff;">== </span><span style="color:#000080;background-color:#f7faff;"><strong>null</strong></span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            api(</span><span style="color:#0000ff;background-color:#f7faff;">101</span><span style="background-color:#f7faff;">, </span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;该接口需要登录权限！&quot;</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     *  鉴定身份
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">authenticate()
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$loginUser </span><span style="background-color:#f7faff;">= Cache::</span><span style="background-color:#f7faff;"><em>get</em></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        </span><span style="color:#808080;background-color:#f7faff;"><em>//当本系统无登录时，去总用户系统认证(实现单点登录)
</em></span><span style="color:#808080;background-color:#f7faff;"><em>        </em></span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$loginUser </span><span style="background-color:#f7faff;">== </span><span style="color:#000080;background-color:#f7faff;"><strong>null</strong></span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$params </span><span style="background-color:#f7faff;">= config(</span><span style="color:#008000;background-color:#f7faff;"><strong>'thirdaccount.users_sys'</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$loginUser </span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;requestUserServer(</span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;/api/user/identityAuth&quot;</strong></span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$params</span><span style="background-color:#f7faff;">, </span><span style="color:#000080;background-color:#f7faff;"><strong>false</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;doLogin(</span><span style="color:#660000;background-color:#f7faff;">$loginUser</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$loginUser</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>user </strong></span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$loginUser</span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>userId </strong></span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$loginUser</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'yunsu_id'</strong></span><span style="background-color:#f7faff;">];
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * 重写 表单验证
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">validate(</span><span style="color:#660000;background-color:#f7faff;">$data</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$message </span><span style="background-color:#f7faff;">= [], </span><span style="color:#660000;background-color:#f7faff;">$batch </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>false</strong></span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$callback </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>null</strong></span><span style="background-color:#f7faff;">)
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$result </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>parent</strong></span><span style="background-color:#f7faff;">::</span><span style="background-color:#f7faff;"><em>validate</em></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$data</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$message</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$batch</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$callback</span><span style="background-color:#f7faff;">); </span><span style="color:#808080;background-color:#f7faff;"><em>// </em></span><span style="color:#0073bf;background-color:#f7faff;"><strong><em>TODO: Change the autogenerated stub
</em></strong></span><span style="color:#0073bf;background-color:#f7faff;"><strong><em>        </em></strong></span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#000080;background-color:#f7faff;"><strong>true </strong></span><span style="background-color:#f7faff;">!== </span><span style="color:#660000;background-color:#f7faff;">$result</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            error(</span><span style="color:#660000;background-color:#f7faff;">$result</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * 按场景验证
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>$data 验证数据
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>null $name 场景名
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">validateByScene1(</span><span style="color:#660000;background-color:#f7faff;">$data</span><span style="background-color:#f7faff;">,</span><span style="color:#660000;background-color:#f7faff;">$name</span><span style="background-color:#f7faff;">)
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$validate </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>new </strong></span><span style="background-color:#f7faff;">Validate(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>rule</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">-&gt;scene(</span><span style="color:#660000;background-color:#f7faff;">$name</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>scene</strong></span><span style="background-color:#f7faff;">[</span><span style="color:#660000;background-color:#f7faff;">$name</span><span style="background-color:#f7faff;">]);
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">-&gt;message(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>msg</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$result </span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">-&gt;scene(</span><span style="color:#660000;background-color:#f7faff;">$name</span><span style="background-color:#f7faff;">)-&gt;check(</span><span style="color:#660000;background-color:#f7faff;">$data</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#000080;background-color:#f7faff;"><strong>true </strong></span><span style="background-color:#f7faff;">!== </span><span style="color:#660000;background-color:#f7faff;">$result</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            error(</span><span style="color:#660000;background-color:#f7faff;">$validate</span><span style="background-color:#f7faff;">-&gt;getError());
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">    </span><span style="color:#808080;background-color:#f7faff;"><em>/**
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * 请求用户系统
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>$path 服务器资源路径 例如：/api/user/login
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>null $params 参数
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@param </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>bool $isVerify 是否严格验证
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     * </em></span><span style="color:#808080;background-color:#f7faff;"><strong><em>@return </em></strong></span><span style="color:#808080;background-color:#f7faff;"><em>mixed
</em></span><span style="color:#808080;background-color:#f7faff;"><em>     */
</em></span><span style="color:#808080;background-color:#f7faff;"><em>    </em></span><span style="color:#000080;background-color:#f7faff;"><strong>protected function </strong></span><span style="background-color:#f7faff;">requestUserServer(</span><span style="color:#660000;background-color:#f7faff;">$path</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$params </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>null</strong></span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$isVerify </span><span style="background-color:#f7faff;">= </span><span style="color:#000080;background-color:#f7faff;"><strong>true</strong></span><span style="background-color:#f7faff;">)
</span><span style="background-color:#f7faff;">    {
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$url </span><span style="background-color:#f7faff;">= </span><span style="color:#008000;background-color:#f7faff;"><strong>'http://users.icloudinn.com' </strong></span><span style="background-color:#f7faff;">. </span><span style="color:#660000;background-color:#f7faff;">$path</span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(strpos(</span><span style="color:#660000;background-color:#f7faff;">$url</span><span style="background-color:#f7faff;">, </span><span style="color:#008000;background-color:#f7faff;"><strong>'?'</strong></span><span style="background-color:#f7faff;">)) {
</span><span style="background-color:#f7faff;">                </span><span style="color:#660000;background-color:#f7faff;">$url </span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$url </span><span style="background-color:#f7faff;">. </span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;&amp;access-token=&quot; </strong></span><span style="background-color:#f7faff;">. </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">            } </span><span style="color:#000080;background-color:#f7faff;"><strong>else </strong></span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">                </span><span style="color:#660000;background-color:#f7faff;">$url </span><span style="background-color:#f7faff;">= </span><span style="color:#660000;background-color:#f7faff;">$url </span><span style="background-color:#f7faff;">. </span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;?access-token=&quot; </strong></span><span style="background-color:#f7faff;">. </span><span style="color:#660000;background-color:#f7faff;">$this</span><span style="background-color:#f7faff;">-&gt;</span><span style="color:#660e7a;background-color:#f7faff;"><strong>accessToken</strong></span><span style="background-color:#f7faff;">;
</span><span style="background-color:#f7faff;">            }
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$params</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$rt </span><span style="background-color:#f7faff;">= HttpClient::</span><span style="background-color:#f7faff;"><em>post</em></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$url</span><span style="background-color:#f7faff;">, </span><span style="color:#660000;background-color:#f7faff;">$params</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        } </span><span style="color:#000080;background-color:#f7faff;"><strong>else </strong></span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">            </span><span style="color:#660000;background-color:#f7faff;">$rt </span><span style="background-color:#f7faff;">= HttpClient::</span><span style="background-color:#f7faff;"><em>get</em></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$url</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#660000;background-color:#f7faff;">$info </span><span style="background-color:#f7faff;">= json_decode(</span><span style="color:#660000;background-color:#f7faff;">$rt</span><span style="background-color:#f7faff;">, </span><span style="color:#000080;background-color:#f7faff;"><strong>true</strong></span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">            </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'code'</strong></span><span style="background-color:#f7faff;">] == </span><span style="color:#0000ff;background-color:#f7faff;">100</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">                </span><span style="color:#000080;background-color:#f7faff;"><strong>return </strong></span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'data'</strong></span><span style="background-color:#f7faff;">];
</span><span style="background-color:#f7faff;">            } </span><span style="color:#000080;background-color:#f7faff;"><strong>else </strong></span><span style="background-color:#f7faff;">{
</span><span style="background-color:#f7faff;">                </span><span style="color:#000080;background-color:#f7faff;"><strong>if </strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$isVerify</span><span style="background-color:#f7faff;">) {
</span><span style="background-color:#f7faff;">                    api(</span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'code'</strong></span><span style="background-color:#f7faff;">], </span><span style="color:#008000;background-color:#f7faff;"><strong>&quot;From Users System. &quot; </strong></span><span style="background-color:#f7faff;">. </span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'msg'</strong></span><span style="background-color:#f7faff;">], </span><span style="color:#660000;background-color:#f7faff;">$info</span><span style="background-color:#f7faff;">[</span><span style="color:#008000;background-color:#f7faff;"><strong>'data'</strong></span><span style="background-color:#f7faff;">]);
</span><span style="background-color:#f7faff;">                }
</span><span style="background-color:#f7faff;">            }
</span><span style="background-color:#f7faff;">        }
</span><span style="background-color:#f7faff;">        </span><span style="color:#000080;background-color:#f7faff;"><strong>die</strong></span><span style="background-color:#f7faff;">(</span><span style="color:#660000;background-color:#f7faff;">$rt</span><span style="background-color:#f7faff;">);
</span><span style="background-color:#f7faff;">    }
</span><span style="background-color:#f7faff;">}
</span></pre>


        </div>
    </div>
</div>